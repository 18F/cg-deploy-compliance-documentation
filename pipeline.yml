jobs:
- name: Deploy compliance.cloud.gov
  public: true
  plan:
  - get: compliance-repository
    trigger: true
  - task: run-compliance-masonry
    config:
      platform: linux
      image: docker:///18fgsa/compliance-masonry
      inputs:
      - name: compliance-repository
      outputs:
      - name: masonry-exports
      run:
        path: "/bin/sh"
        args:
        - -exc
        - |
          cd compliance-repository
          compliance-masonry --verbose get
          compliance-masonry --verbose docs gitbook -e ../masonry-exports FedRAMP-moderate
  - task: create-gitbook
    config:
      platform: linux
      image: "docker:///18fgsa/cg-compliance-gitbook"
      inputs:
      - name: compliance-repository
      - name: masonry-exports
      outputs:
      - name: prepared-gitbook
      run:
        path: bash
        args:
        - -exc
        - |
          mv compliance-repository/book.json prepared-gitbook/book.json
          mv compliance-repository/Staticfile prepared-gitbook/Staticfile
          mv masonry-exports/* prepared-gitbook/
          cd prepared-gitbook
          gitbook build
  - task: check-links
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: ruby
          tag: '2.3-alpine'
      inputs:
      - name: prepared-gitbook
      run:
        path: sh
        args:
        - -exc
        - |
          # install system libraries for FFI and Nokogiri
          # https://github.com/ffi/ffi/issues/485#issuecomment-209778567
          # https://github.com/gliderlabs/docker-alpine/issues/53#issuecomment-179486583
          apk add --update \
            build-base \
            libffi-dev \
            libxml2-dev \
            libxslt-dev
          gem install nokogiri -- --use-system-libraries
          gem install html-proofer
          cd prepared-gitbook/_book
          htmlproofer --disable-external .
  - put: deploy-documentation
    params:
      manifest: compliance-repository/manifest.yaml
      path: prepared-gitbook

resources:
- name: compliance-repository
  type: git
  source:
    uri: https://github.com/18F/cg-compliance.git
    branch: master
- name: deploy-documentation
  type: cf
  source:
    api: {{API}}
    username: {{USERNAME}}
    password: {{PASSWORD}}
    organization: {{ORG}}
    space: {{SPACE}}
